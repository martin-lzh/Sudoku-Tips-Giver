<!--
Sudoku Tips Giver
Copyright (c) 2025 Sudoku Tips Giver

A web application that helps users solve Sudoku puzzles with intelligent hints.
-->

<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Êï∞Áã¨ÊèêÁ§∫Âô® | Sudoku Tips Giver</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üé≤</text></svg>">
    <style>
        :root {
            /* Âü∫Á°ÄÂ∞∫ÂØ∏ÂèòÈáè */
            --vh: 1vh;
            --vw: 1vw;
            --min-cell-size: 30px;
            --max-cell-size: 50px;
            --header-height: 60px;
            --controls-height: 180px;
            --grid-padding: 10px;
            
            /* Âä®ÊÄÅËÆ°ÁÆóÁΩëÊ†ºÂ∞∫ÂØ∏ */
            --available-height: calc(100vh - var(--header-height) - var(--controls-height));
            --available-width: calc(100vw - 40px);
            --cell-size: clamp(
                var(--min-cell-size),
                min(
                    calc((var(--available-height) - var(--grid-padding) * 2) / 9),
                    calc((var(--available-width) - var(--grid-padding) * 2) / 9)
                ),
                var(--max-cell-size)
            );
            
            /* È¢úËâ≤ÂèòÈáè - Êòé‰∫Æ‰∏ªÈ¢ò */
            --bg-color: #f0f0f0;
            --container-bg: white;
            --text-color: #333;
            --cell-bg: white;
            --cell-border: #999;
            --grid-border: #333;
            --grid-bg: #ffffff;
            --highlight-bg: #e6f3ff;
            --button-bg: #007bff;
            --button-hover: #0056b3;
            --button-text: #ffffff;
            --success-bg: #e6ffe6;
            --success-color: #28a745;
            --error-bg: #ffe6e6;
            --error-color: #dc3545;
        }

        [data-theme="dark"] {
            --bg-color: #222;
            --container-bg: #333;
            --text-color: #fff;
            --cell-bg: #444;
            --cell-border: #666;
            --grid-border: #888;
            --grid-bg: #333;
            --highlight-bg: #1a3f66;
            --button-bg: #0056b3;
            --button-hover: #003d80;
            --button-text: #ffffff;
            --success-bg: #143322;
            --success-color: #28a745;
            --error-bg: #331111;
            --error-color: #dc3545;
        }

        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            text-align: center;
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            gap: calc(var(--cell-size) * 0.5);
        }

        h1 {
            margin: calc(var(--cell-size) * 0.5) 0;
            font-size: calc(var(--cell-size) * 0.6);
            word-wrap: break-word;
            height: var(--header-height);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .controls {
            margin-bottom: calc(var(--cell-size) * 0.5);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: calc(var(--cell-size) * 0.3);
            width: 100%;
            max-width: calc(var(--cell-size) * 12);
            height: var(--controls-height);
        }

        .buttons {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: calc(var(--cell-size) * 0.2);
            width: 100%;
        }

        select, button {
            padding: calc(var(--cell-size) * 0.2) calc(var(--cell-size) * 0.4);
            font-size: calc(var(--cell-size) * 0.35);
            min-width: calc(var(--cell-size) * 2.5);
            height: calc(var(--cell-size) * 0.8);
            border: none;
            border-radius: 4px;
            background-color: var(--button-bg);
            color: var(--button-text);
            cursor: pointer;
            transition: background-color 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        select {
            background-color: var(--container-bg);
            color: var(--text-color);
            border: 1px solid var(--button-bg);
        }

        button:hover {
            background-color: var(--button-hover);
        }

        .grid {
            display: inline-block;
            background-color: var(--grid-bg);
            padding: var(--grid-padding);
            border-radius: calc(var(--cell-size) * 0.2);
            margin: 0 auto;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }

        .row {
            display: flex;
            justify-content: center;
        }

        .cell {
            width: var(--cell-size);
            height: var(--cell-size);
            border: 1px solid var(--cell-border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: calc(var(--cell-size) * 0.5);
            cursor: pointer;
            background-color: var(--cell-bg);
            transition: all 0.3s ease;
        }

        .cell input {
            width: 100%;
            height: 100%;
            border: none;
            text-align: center;
            font-size: inherit;
            background: transparent;
            color: var(--text-color);
            cursor: pointer;
        }

        .theme-toggle, .lang-toggle, .help-button {
            position: fixed;
            top: calc(var(--cell-size) * 0.2);
            height: calc(var(--cell-size) * 0.8);
            font-size: calc(var(--cell-size) * 0.35);
            min-width: auto;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--button-bg);
            color: var(--button-text);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .theme-toggle:hover, .lang-toggle:hover, .help-button:hover {
            background-color: var(--button-hover);
            transform: translateY(-1px);
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.15);
        }

        .help-button {
            right: calc(var(--cell-size) * 0.2);
            width: calc(var(--cell-size) * 0.8);
        }

        .lang-toggle {
            right: calc(var(--cell-size) * 1.2);
            width: calc(var(--cell-size) * 1.3);
        }

        .theme-toggle {
            right: calc(var(--cell-size) * 2.7);
            width: calc(var(--cell-size) * 0.8);
        }

        @media screen and (max-width: 600px) {
            :root {
                --min-cell-size: 25px;
                --header-height: 50px;
                --controls-height: 160px;
            }

            body {
                padding: 10px;
            }

            h1 {
                font-size: calc(var(--cell-size) * 0.7);
            }

            select, button {
                padding: calc(var(--cell-size) * 0.15) calc(var(--cell-size) * 0.3);
                font-size: calc(var(--cell-size) * 0.4);
                min-width: calc(var(--cell-size) * 2);
            }
        }

        @media screen and (max-width: 360px) {
            :root {
                --min-cell-size: 20px;
                --header-height: 40px;
                --controls-height: 140px;
            }

            body {
                padding: 5px;
            }

            .buttons {
                gap: calc(var(--cell-size) * 0.15);
            }
        }

        .loading-overlay {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(3px);
            z-index: 100;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        [data-theme="dark"] .loading-overlay {
            background-color: rgba(0, 0, 0, 0.8);
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--button-bg);
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
        }

        .button-spinner {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid #fff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
            margin-left: 8px;
            vertical-align: middle;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .cell input:disabled {
            color: var(--text-color);
            opacity: 0.7;
            cursor: not-allowed;
            background: transparent;
            caret-color: transparent;  /* ÈöêËóèÂÖâÊ†á */
        }

        .cell input.initial {
            font-weight: bold;
            color: var(--text-color);
        }

        .cell input:not(:disabled):focus {
            outline: 2px solid var(--button-bg);
        }

        .cell.highlighted {
            background-color: var(--highlight-bg);
        }

        .grid-line-right {
            border-right: 2px solid var(--grid-border) !important;
        }

        .grid-line-bottom {
            border-bottom: 2px solid var(--grid-border) !important;
        }

        .message {
            margin-top: 20px;
            padding: 10px;
            border-radius: 5px;
            min-height: 50px;
        }

        .error {
            background-color: var(--error-bg);
            color: var(--error-color);
        }

        .success {
            background-color: var(--success-bg);
            color: var(--success-color);
        }

        .buttons select {
            font-size: 14px;
            border: 1px solid var(--button-bg);
            border-radius: 5px;
            background-color: var(--cell-bg);
            color: var(--text-color);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .buttons select:hover {
            border-color: var(--button-hover);
        }

        .buttons select option {
            background-color: var(--container-bg);
            color: var(--text-color);
        }

        .help-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .help-content {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--container-bg);
            color: var(--text-color);
            padding: 20px;
            border-radius: 10px;
            width: 80%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .close-help {
            position: absolute;
            right: 20px;
            top: 20px;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-color);
        }

        .help-content h2 {
            margin-top: 0;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--text-color);
        }

        .help-content h3 {
            margin-top: 20px;
            color: var(--button-bg);
        }

        .help-content ul {
            padding-left: 20px;
        }

        .help-content li {
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-controls">
            <h1 class="lang-zh">Êï∞Áã¨ÊèêÁ§∫Âô®</h1>
            <h1 class="lang-en" style="display: none;">Sudoku Tips Giver</h1>
            <div class="control-buttons">
                <button class="theme-toggle" onclick="toggleTheme()">üåì</button>
                <button class="lang-toggle" onclick="toggleLanguage()">‰∏≠/En</button>
                <button class="help-button" onclick="toggleHelp()">?</button>
            </div>
        </div>
        <div class="buttons">
            <select id="difficulty" class="lang-zh">
                <option value="easy">ÁÆÄÂçï</option>
                <option value="medium" selected>‰∏≠Á≠â</option>
                <option value="hard">Âõ∞Èöæ</option>
            </select>
            <select id="difficulty-en" class="lang-en" style="display: none;">
                <option value="easy">Easy</option>
                <option value="medium" selected>Medium</option>
                <option value="hard">Hard</option>
            </select>
            <button onclick="generateSudoku()" class="lang-zh">ÁîüÊàêÊï∞Áã¨</button>
            <button onclick="getHint()" class="lang-zh">Ëé∑ÂèñÊèêÁ§∫</button>
            <button onclick="showAnswer()" class="lang-zh">ÊòæÁ§∫Á≠îÊ°à</button>
            <button onclick="clearBoard()" class="lang-zh">Ê∏ÖÁ©∫Ê£ãÁõò</button>
            <button onclick="generateSudoku()" class="lang-en" style="display: none;">Generate Sudoku</button>
            <button onclick="getHint()" class="lang-en" style="display: none;">Get Hint</button>
            <button onclick="showAnswer()" class="lang-en" style="display: none;">Show Answer</button>
            <button onclick="clearBoard()" class="lang-en" style="display: none;">Clear Board</button>
        </div>
        <div class="sudoku-grid" id="grid">
            <div class="loading-overlay" id="gridLoading" style="display: none;">
                <div class="loading-spinner"></div>
            </div>
        </div>
        <div class="message" id="message"></div>
    </div>

    <!-- Â∏ÆÂä©Ê®°ÊÄÅÊ°Ü -->
    <div class="help-modal" id="helpModal">
        <div class="help-content">
            <span class="close-help" onclick="toggleHelp()">&times;</span>
            <div class="lang-zh">
                <h2>‰ΩøÁî®Â∏ÆÂä©</h2>
                
                <h3>ÈöæÂ∫¶Á∫ßÂà´</h3>
                <ul>
                    <li><strong>ÁÆÄÂçï</strong>ÔºöÂàùÂßãÊï∞Â≠ó 35-40 ‰∏™ÔºåÈÄÇÂêàÂàùÂ≠¶ËÄÖ</li>
                    <li><strong>‰∏≠Á≠â</strong>ÔºöÂàùÂßãÊï∞Â≠ó 25-30 ‰∏™ÔºåÈúÄË¶Å‰∏ÄÂÆöËß£È¢òÊäÄÂ∑ß</li>
                    <li><strong>Âõ∞Èöæ</strong>ÔºöÂàùÂßãÊï∞Â≠ó 20-25 ‰∏™ÔºåÂØåÊúâÊåëÊàòÊÄß</li>
                </ul>

                <h3>ÊåâÈíÆÂäüËÉΩ</h3>
                <ul>
                    <li><strong>ÁîüÊàêÊï∞Áã¨</strong>ÔºöÊ†πÊçÆÈÄâÊã©ÁöÑÈöæÂ∫¶ÁîüÊàêÊñ∞ÁöÑÊï∞Áã¨È¢òÁõÆ</li>
                    <li><strong>Ëé∑ÂèñÊèêÁ§∫</strong>ÔºöÈ´ò‰∫ÆÊòæÁ§∫ÊúÄÈÄÇÂêàÂ°´ÂÜôÁöÑÊ†ºÂ≠êÔºåÂπ∂Êèê‰æõÂèØËÉΩÁöÑÊï∞Â≠ó</li>
                    <li><strong>ÊòæÁ§∫Á≠îÊ°à</strong>ÔºöÂú®È´ò‰∫ÆÊ†ºÂ≠ê‰∏≠Â°´ÂÖ•Ê≠£Á°ÆÁ≠îÊ°à</li>
                    <li><strong>Ê∏ÖÁ©∫Ê£ãÁõò</strong>ÔºöÊ∏ÖÈô§ÊâÄÊúâÂ∑≤Â°´ÂÜôÁöÑÊï∞Â≠óÔºåÈáçÊñ∞ÂºÄÂßã</li>
                </ul>

                <h3>Êìç‰ΩúËØ¥Êòé</h3>
                <ul>
                    <li>‰ΩøÁî®Èº†Ê†áÁÇπÂáªÊ†ºÂ≠êÊàñÈîÆÁõòÊñπÂêëÈîÆËøõË°åÂØºËà™</li>
                    <li>Áõ¥Êé•ËæìÂÖ•Êï∞Â≠ó 1-9</li>
                    <li>ÊåâÈÄÄÊ†ºÈîÆÊ∏ÖÈô§ÂΩìÂâçÊ†ºÂ≠ê</li>
                    <li>Á≥ªÁªü‰ºöËá™Âä®Ê£ÄÊü•ÊòØÂê¶ÂÆåÊàê</li>
                </ul>

                <h3>ÁïåÈù¢ÊéßÂà∂</h3>
                <ul>
                    <li>üåìÔºöÂàáÊç¢Ê∑±Ëâ≤/ÊµÖËâ≤‰∏ªÈ¢ò</li>
                    <li>‰∏≠/EnÔºöÂàáÊç¢‰∏≠Êñá/Ëã±ÊñáÁïåÈù¢</li>
                    <li>?ÔºöÊòæÁ§∫/ÈöêËóèÂ∏ÆÂä©‰ø°ÊÅØ</li>
                </ul>
            </div>
            <div class="lang-en" style="display: none;">
                <h2>Help Guide</h2>
                
                <h3>Difficulty Levels</h3>
                <ul>
                    <li><strong>Easy</strong>: 35-40 initial numbers, suitable for beginners</li>
                    <li><strong>Medium</strong>: 25-30 initial numbers, requires some solving techniques</li>
                    <li><strong>Hard</strong>: 20-25 initial numbers, challenging</li>
                </ul>

                <h3>Button Functions</h3>
                <ul>
                    <li><strong>Generate Sudoku</strong>: Creates a new puzzle based on selected difficulty</li>
                    <li><strong>Get Hint</strong>: Highlights the most suitable cell to fill and shows possible numbers</li>
                    <li><strong>Show Answer</strong>: Fills in the correct number in the highlighted cell</li>
                    <li><strong>Clear Board</strong>: Removes all filled numbers and starts over</li>
                </ul>

                <h3>How to Play</h3>
                <ul>
                    <li>Use mouse clicks or arrow keys for navigation</li>
                    <li>Input numbers 1-9 directly</li>
                    <li>Press Backspace to clear current cell</li>
                    <li>System automatically checks for completion</li>
                </ul>

                <h3>Interface Controls</h3>
                <ul>
                    <li>üåì: Toggle dark/light theme</li>
                    <li>‰∏≠/En: Switch between Chinese/English</li>
                    <li>?: Show/hide help information</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        let board = Array(9).fill().map(() => Array(9).fill(0));
        let highlightedCell = null;
        let currentLanguage = 'zh';
        let solvedBoard = null;  // Â≠òÂÇ®ÂÆåÊï¥Ëß£
        let isLocked = false;    // ÊòØÂê¶ÈîÅÂÆöËæìÂÖ•
        let initialCells = new Set();  // Â≠òÂÇ®ÂàùÂßãÊï∞Â≠óÁöÑ‰ΩçÁΩÆ
        
        // ËØ≠Ë®ÄÈÖçÁΩÆ
        const translations = {
            zh: {
                noUniqueSolution: 'Ëøô‰∏™Êï∞Áã¨Ê≤°ÊúâÂîØ‰∏ÄËß£ÔºÅ',
                completed: 'ÊÅ≠ÂñúÔºÅÊï∞Áã¨Â∑≤Ê≠£Á°ÆÂÆåÊàêÔºÅ',
                incorrect: 'Êï∞Áã¨Â°´ÂÜôÊúâËØØÔºåËØ∑Ê£ÄÊü•ÂêéÈáçËØïÔºÅ',
                error: 'ÂèëÁîüÈîôËØØÔºåËØ∑ÈáçËØï',
                inputLocked: 'Â∑≤ÈîÅÂÆöËæìÂÖ•„ÄÇÂ¶ÇÈúÄ‰øÆÊîπÔºåËØ∑ÁÇπÂáªÊ∏ÖÁ©∫Ê£ãÁõòÈáçÊñ∞ÂºÄÂßã„ÄÇ',
                generateError: 'ÁîüÊàêÊï∞Áã¨Êó∂ÂèëÁîüÈîôËØØ'
            },
            en: {
                noUniqueSolution: 'This Sudoku has no unique solution!',
                completed: 'Congratulations! Sudoku completed correctly!',
                incorrect: 'The Sudoku is incorrect. Please check and try again!',
                error: 'An error occurred, please try again',
                inputLocked: 'Input is locked. To modify, please click Clear Board to start over.',
                generateError: 'Error generating Sudoku'
            }
        };

        function toggleTheme() {
            document.body.dataset.theme = document.body.dataset.theme === 'dark' ? 'light' : 'dark';
            localStorage.setItem('theme', document.body.dataset.theme);
        }

        function toggleLanguage() {
            currentLanguage = currentLanguage === 'zh' ? 'en' : 'zh';
            document.querySelectorAll('.lang-zh').forEach(el => 
                el.style.display = currentLanguage === 'zh' ? '' : 'none'
            );
            document.querySelectorAll('.lang-en').forEach(el => 
                el.style.display = currentLanguage === 'en' ? '' : 'none'
            );
            localStorage.setItem('language', currentLanguage);
            
            // Êõ¥Êñ∞Ê∂àÊÅØÂÜÖÂÆπ
            const messageDiv = document.getElementById('message');
            if (messageDiv.textContent) {
                translateMessage(messageDiv);
            }
        }

        function translateMessage(messageDiv) {
            // ÁøªËØëÊèêÁ§∫Ê∂àÊÅØ
            Object.entries(translations[currentLanguage === 'zh' ? 'en' : 'zh']).forEach(([key, value]) => {
                if (messageDiv.textContent.includes(value)) {
                    messageDiv.textContent = messageDiv.textContent.replace(
                        value,
                        translations[currentLanguage][key]
                    );
                    return;
                }
            });
            
            // ÁøªËØëÊï∞Áã¨ÊèêÁ§∫Ê∂àÊÅØ
            if (currentLanguage === 'en') {
                messageDiv.textContent = messageDiv.textContent
                    .replace(/Âú®?Á¨¨(\d+)Ë°åÁ¨¨(\d+)Âàó/g, 'Row $1, Column $2')
                    .replace(/Âè™ËÉΩÂ°´ÂÖ•Êï∞Â≠ó(\d+)/, 'can only be filled with number $1')
                    .replace(/ÂèØ‰ª•Â°´ÂÖ•ÁöÑÊï∞Â≠óÊúâ:/, 'Possible numbers are:');
            } else {
                messageDiv.textContent = messageDiv.textContent
                    .replace(/Row (\d+), Column (\d+)/g, 'Á¨¨$1Ë°åÁ¨¨$2Âàó')
                    .replace(/can only be filled with number (\d+)/, 'Âè™ËÉΩÂ°´ÂÖ•Êï∞Â≠ó$1')
                    .replace(/Possible numbers are:/, 'ÂèØ‰ª•Â°´ÂÖ•ÁöÑÊï∞Â≠óÊúâ:');
            }
        }

        // ÂàùÂßãÂåñ‰∏ªÈ¢òÂíåËØ≠Ë®Ä
        function initializeSettings() {
            // ËÆæÁΩÆ‰∏ªÈ¢ò
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.body.dataset.theme = savedTheme;
            
            // ËÆæÁΩÆËØ≠Ë®Ä
            const savedLanguage = localStorage.getItem('language') || 'zh';
            if (savedLanguage !== currentLanguage) {
                currentLanguage = savedLanguage;
                toggleLanguage();
            }
        }

        function updateGrid() {
            const inputs = document.querySelectorAll('#grid input');  // ‰øÆÊîπÈÄâÊã©Âô®
            board.forEach((row, i) => {
                row.forEach((value, j) => {
                    const input = inputs[i * 9 + j];
                    if (input) {  // Ê∑ªÂä†Ê£ÄÊü•
                        input.value = value || '';
                        input.disabled = isLocked || initialCells.has(`${i},${j}`);
                        input.className = initialCells.has(`${i},${j}`) ? 'initial' : '';
                    }
                });
            });
        }

        async function generateSudoku() {
            try {
                // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
                const gridLoading = document.getElementById('gridLoading');
                const generateButton = document.querySelector(`.lang-${currentLanguage}[onclick="generateSudoku()"]`);
                
                // Âè™Á¶ÅÁî®Ê∏∏ÊàèÁõ∏ÂÖ≥ÁöÑÊåâÈíÆÂíåÈÄâÊã©Ê°Ü
                const gameButtons = document.querySelectorAll('.buttons button');
                const difficultySelects = document.querySelectorAll('#difficulty, #difficulty-en');
                
                if (gridLoading) {
                    gridLoading.style.display = 'flex';
                }
                
                if (generateButton) {
                    generateButton.innerHTML = currentLanguage === 'zh' ? 
                        'Ê≠£Âú®ÁîüÊàê<span class="button-spinner"></span>' : 
                        'Generating<span class="button-spinner"></span>';
                }

                // Âè™Á¶ÅÁî®Ê∏∏ÊàèÁõ∏ÂÖ≥ÁöÑÊåâÈíÆÂíåÈÄâÊã©Ê°Ü
                gameButtons.forEach(btn => btn.disabled = true);
                difficultySelects.forEach(select => select.disabled = true);

                const difficulty = document.getElementById(currentLanguage === 'zh' ? 'difficulty' : 'difficulty-en')?.value || 'medium';
                const response = await fetch('/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ difficulty: difficulty })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                if (data.success) {
                    board = data.board;
                    solvedBoard = data.solution;
                    initialCells.clear();
                    isLocked = false;
                    
                    board.forEach((row, i) => {
                        row.forEach((value, j) => {
                            if (value) {
                                initialCells.add(`${i},${j}`);
                            }
                        });
                    });
                    
                    updateGrid();
                    clearHighlight();
                    const messageDiv = document.getElementById('message');
                    if (messageDiv) {
                        messageDiv.textContent = '';
                        messageDiv.className = 'message';
                    }
                } else {
                    console.error('Generation failed:', data.message);
                    const messageDiv = document.getElementById('message');
                    if (messageDiv) {
                        messageDiv.className = 'message error';
                        messageDiv.textContent = data.message || translations[currentLanguage].generateError;
                    }
                }
            } catch (error) {
                console.error('Error:', error);
                const messageDiv = document.getElementById('message');
                if (messageDiv) {
                    messageDiv.className = 'message error';
                    messageDiv.textContent = translations[currentLanguage].generateError + (error.message ? `: ${error.message}` : '');
                }
            } finally {
                // ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅ
                const gridLoading = document.getElementById('gridLoading');
                const generateButton = document.querySelector(`.lang-${currentLanguage}[onclick="generateSudoku()"]`);
                const gameButtons = document.querySelectorAll('.buttons button');
                const difficultySelects = document.querySelectorAll('#difficulty, #difficulty-en');
                
                // ÁßªÈô§Âä†ËΩΩÁä∂ÊÄÅ
                if (gridLoading) {
                    gridLoading.style.display = 'none';
                }
                
                if (generateButton) {
                    generateButton.innerHTML = currentLanguage === 'zh' ? 'ÁîüÊàêÊï∞Áã¨' : 'Generate Sudoku';
                }
                
                // Âè™ÂêØÁî®Ê∏∏ÊàèÁõ∏ÂÖ≥ÁöÑÊåâÈíÆÂíåÈÄâÊã©Ê°Ü
                gameButtons.forEach(btn => btn.disabled = false);
                difficultySelects.forEach(select => select.disabled = false);
            }
        }

        function createGrid() {
            const grid = document.getElementById('grid');
            grid.innerHTML = '';  // Ê∏ÖÁ©∫Áé∞ÊúâÂÜÖÂÆπ
            
            for (let i = 0; i < 9; i++) {
                const row = document.createElement('div');
                row.className = 'row';
                
                for (let j = 0; j < 9; j++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    if (j === 2 || j === 5) cell.className += ' grid-line-right';
                    if (i === 2 || i === 5) cell.className += ' grid-line-bottom';

                    const input = document.createElement('input');
                    input.type = 'text';
                    input.maxLength = 1;
                    input.dataset.row = i;
                    input.dataset.col = j;
                    
                    input.addEventListener('input', (e) => {
                        if (isLocked || initialCells.has(`${i},${j}`)) {
                            e.preventDefault();
                            e.target.value = board[i][j] || '';
                            const messageDiv = document.getElementById('message');
                            messageDiv.className = 'message error';
                            messageDiv.textContent = translations[currentLanguage].inputLocked;
                            return;
                        }
                        
                        const value = e.target.value;
                        if (value === '0') {
                            e.target.value = '';
                            board[i][j] = 0;
                            moveToNextCell(i, j);
                            checkCompletion();
                        } else if (value && (isNaN(value) || value < 0 || value > 9)) {
                            e.target.value = '';
                        } else {
                            board[i][j] = value ? parseInt(value) : 0;
                            if (value) {
                                moveToNextCell(i, j);
                            }
                            checkCompletion();
                        }
                    });

                    input.addEventListener('keydown', (e) => {
                        const row = parseInt(e.target.dataset.row);
                        const col = parseInt(e.target.dataset.col);
                        
                        switch(e.key) {
                            case 'ArrowUp':
                                moveFocus(row - 1, col);
                                e.preventDefault();
                                break;
                            case 'ArrowDown':
                                moveFocus(row + 1, col);
                                e.preventDefault();
                                break;
                            case 'ArrowLeft':
                                moveFocus(row, col - 1);
                                e.preventDefault();
                                break;
                            case 'ArrowRight':
                                moveFocus(row, col + 1);
                                e.preventDefault();
                                break;
                            case ' ':
                                moveToNextCell(row, col);
                                e.preventDefault();
                                break;
                            case 'Backspace':
                                if (!e.target.value) {
                                    moveToPrevCell(row, col);
                                    e.preventDefault();
                                }
                                break;
                        }
                    });
                    
                    cell.appendChild(input);
                    row.appendChild(cell);
                }
                grid.appendChild(row);
            }
            updateGrid();
        }

        function moveToNextCell(currentRow, currentCol) {
            let nextRow = currentRow;
            let nextCol = currentCol + 1;
            
            if (nextCol >= 9) {
                nextCol = 0;
                nextRow++;
            }
            if (nextRow < 9) {
                moveFocus(nextRow, nextCol);
            }
        }

        function moveToPrevCell(currentRow, currentCol) {
            let prevRow = currentRow;
            let prevCol = currentCol - 1;
            
            while (prevRow >= 0) {
                while (prevCol >= 0) {
                    const input = document.querySelector(`[data-row="${prevRow}"][data-col="${prevCol}"]`);
                    if (input && !input.disabled) {
                        input.focus();
                        return;
                    }
                    prevCol--;
                }
                prevRow--;
                prevCol = 8;
            }
        }

        function moveFocus(row, col) {
            if (row >= 0 && row < 9 && col >= 0 && col < 9) {
                const nextInput = document.querySelector(`[data-row="${row}"][data-col="${col}"]`);
                if (nextInput && !nextInput.disabled) {
                    nextInput.focus();
                } else {
                    // Â¶ÇÊûú‰∏ã‰∏Ä‰∏™Ê†ºÂ≠êË¢´Á¶ÅÁî®ÔºåÁªßÁª≠ÂØªÊâæ‰∏ã‰∏Ä‰∏™ÂèØÁî®ÁöÑÊ†ºÂ≠ê
                    let nextRow = row;
                    let nextCol = col;
                    while (nextRow < 9) {
                        while (nextCol < 9) {
                            const input = document.querySelector(`[data-row="${nextRow}"][data-col="${nextCol}"]`);
                            if (input && !input.disabled) {
                                input.focus();
                                return;
                            }
                            nextCol++;
                        }
                        nextRow++;
                        nextCol = 0;
                    }
                }
            }
        }

        function clearHighlight() {
            if (highlightedCell) {
                highlightedCell.classList.remove('highlighted');
                highlightedCell = null;
            }
        }

        function highlightCell(row, col) {
            clearHighlight();
            const input = document.querySelector(`#grid input[data-row="${row}"][data-col="${col}"]`);
            if (input) {
                input.parentElement.classList.add('highlighted');
                highlightedCell = input.parentElement;
            }
        }

        async function getHint() {
            try {
                // È¶ñÂÖàÊ£ÄÊü•ÊòØÂê¶ÊâÄÊúâÊ†ºÂ≠êÈÉΩÂ∑≤Â°´ÂÜô
                let isFull = true;
                for (let i = 0; i < 9; i++) {
                    for (let j = 0; j < 9; j++) {
                        if (board[i][j] === 0) {
                            isFull = false;
                            break;
                        }
                    }
                    if (!isFull) break;
                }

                if (isFull) {
                    // Â¶ÇÊûúÂ∑≤Â°´Êª°ÔºåÊ£ÄÊü•ÊòØÂê¶Ê≠£Á°Æ
                    const messageDiv = document.getElementById('message');
                    clearHighlight(); // Ê∏ÖÈô§È´ò‰∫Æ
                    
                    // Ê£ÄÊü•ÊØè‰∏ÄË°å
                    for (let i = 0; i < 9; i++) {
                        let row = new Set();
                        for (let j = 0; j < 9; j++) {
                            if (row.has(board[i][j])) {
                                messageDiv.className = 'message error';
                                messageDiv.textContent = translations[currentLanguage].incorrect;
                                return;
                            }
                            row.add(board[i][j]);
                        }
                    }
                    
                    // Ê£ÄÊü•ÊØè‰∏ÄÂàó
                    for (let j = 0; j < 9; j++) {
                        let col = new Set();
                        for (let i = 0; i < 9; i++) {
                            if (col.has(board[i][j])) {
                                messageDiv.className = 'message error';
                                messageDiv.textContent = translations[currentLanguage].incorrect;
                                return;
                            }
                            col.add(board[i][j]);
                        }
                    }
                    
                    // Ê£ÄÊü•ÊØè‰∏™3x3ÊñπÊ†º
                    for (let block = 0; block < 9; block++) {
                        let square = new Set();
                        let startRow = Math.floor(block / 3) * 3;
                        let startCol = (block % 3) * 3;
                        for (let i = 0; i < 3; i++) {
                            for (let j = 0; j < 3; j++) {
                                let num = board[startRow + i][startCol + j];
                                if (square.has(num)) {
                                    messageDiv.className = 'message error';
                                    messageDiv.textContent = translations[currentLanguage].incorrect;
                                    return;
                                }
                                square.add(num);
                            }
                        }
                    }
                    
                    // Â¶ÇÊûúÊâÄÊúâÊ£ÄÊü•ÈÉΩÈÄöËøáÔºåÊòæÁ§∫ÂÆåÊàêÊ∂àÊÅØ
                    messageDiv.className = 'message success';
                    messageDiv.textContent = translations[currentLanguage].completed;
                    return;
                }

                const response = await fetch('/get_hint', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ board: board })
                });
                
                const data = await response.json();
                const messageDiv = document.getElementById('message');
                
                if (data.success) {
                    messageDiv.className = 'message success';
                    messageDiv.textContent = data.message;
                    messageDiv.dataset.number = data.number;
                    messageDiv.dataset.possibleNumbers = JSON.stringify(data.possible_numbers);
                    solvedBoard = data.solved_board;  // ‰øùÂ≠òÂÆåÊï¥Ëß£
                    highlightCell(data.row, data.col);
                } else {
                    messageDiv.className = 'message error';
                    messageDiv.textContent = currentLanguage === 'zh' ? 
                        translations.zh.noUniqueSolution : 
                        translations.en.noUniqueSolution;
                    messageDiv.dataset.number = '';
                    messageDiv.dataset.possibleNumbers = '';
                    solvedBoard = null;
                    clearHighlight();
                }
                
                if (currentLanguage === 'en') {
                    translateMessage(messageDiv);
                }
            } catch (error) {
                console.error('Error:', error);
                const messageDiv = document.getElementById('message');
                messageDiv.className = 'message error';
                messageDiv.textContent = currentLanguage === 'zh' ? 
                    translations.zh.error : 
                    translations.en.error;
            }
        }

        async function showAnswer() {
            // Ê£ÄÊü•ÊòØÂê¶ÊâÄÊúâÊ†ºÂ≠êÈÉΩÂ∑≤Â°´ÂÜô
            let isFull = true;
            for (let i = 0; i < 9; i++) {
                for (let j = 0; j < 9; j++) {
                    if (board[i][j] === 0) {
                        isFull = false;
                        break;
                    }
                }
                if (!isFull) break;
            }

            if (isFull) {
                await getHint();  // Â¶ÇÊûúÂ∑≤Â°´Êª°ÔºåË∞ÉÁî®getHintÊ£ÄÊü•ÊòØÂê¶Ê≠£Á°Æ
                return;
            }

            const messageDiv = document.getElementById('message');
            
            if (!highlightedCell || !messageDiv.className.includes('success')) {
                await getHint();
                if (!messageDiv.className.includes('success')) {
                    return;
                }
            }
            
            if (solvedBoard && highlightedCell) {
                const input = highlightedCell.querySelector('input');
                if (input) {
                    const row = parseInt(input.dataset.row);
                    const col = parseInt(input.dataset.col);
                    const number = solvedBoard[row][col];
                    if (number) {
                        input.value = number;
                        board[row][col] = number;
                        initialCells.add(`${row},${col}`);  // Â∞ÜÂ°´ÂÜôÁöÑÊ†ºÂ≠êÊ†áËÆ∞‰∏∫ÂàùÂßãÊ†ºÂ≠ê
                        updateGrid();  // Êõ¥Êñ∞ÁΩëÊ†º‰ª•Â∫îÁî®Á¶ÅÁî®Áä∂ÊÄÅ
                        
                        // ‰ΩøÁî®getHintÊù•ÂØªÊâæ‰∏ã‰∏Ä‰∏™ÈúÄË¶ÅÊèêÁ§∫ÁöÑÊ†ºÂ≠ê
                        await getHint();
                    }
                }
            }
        }

        function clearBoard() {
            board = Array(9).fill().map(() => Array(9).fill(0));
            solvedBoard = null;
            isLocked = false;
            initialCells.clear();
            clearHighlight();
            updateGrid();
            // Ê∏ÖÈô§ÊèêÁ§∫‰ø°ÊÅØ
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = '';
            messageDiv.className = 'message';
            messageDiv.dataset.number = '';
            messageDiv.dataset.possibleNumbers = '';
        }

        function checkCompletion() {
            // Ê£ÄÊü•ÊòØÂê¶ÊâÄÊúâÊ†ºÂ≠êÈÉΩÂ∑≤Â°´ÂÜô
            let isFull = true;
            for (let i = 0; i < 9; i++) {
                for (let j = 0; j < 9; j++) {
                    if (board[i][j] === 0) {
                        isFull = false;
                        break;
                    }
                }
            }

            if (isFull) {
                // Ê£ÄÊü•ÊòØÂê¶Ê≠£Á°Æ
                let isCorrect = true;
                // Ê£ÄÊü•ÊØè‰∏ÄË°å
                for (let i = 0; i < 9; i++) {
                    let row = new Set();
                    for (let j = 0; j < 9; j++) {
                        if (row.has(board[i][j])) {
                            isCorrect = false;
                            break;
                        }
                        row.add(board[i][j]);
                    }
                }
                // Ê£ÄÊü•ÊØè‰∏ÄÂàó
                for (let j = 0; j < 9; j++) {
                    let col = new Set();
                    for (let i = 0; i < 9; i++) {
                        if (col.has(board[i][j])) {
                            isCorrect = false;
                            break;
                        }
                        col.add(board[i][j]);
                    }
                }
                // Ê£ÄÊü•ÊØè‰∏™3x3ÊñπÊ†º
                for (let block = 0; block < 9; block++) {
                    let square = new Set();
                    let startRow = Math.floor(block / 3) * 3;
                    let startCol = (block % 3) * 3;
                    for (let i = 0; i < 3; i++) {
                        for (let j = 0; j < 3; j++) {
                            let num = board[startRow + i][startCol + j];
                            if (square.has(num)) {
                                isCorrect = false;
                                break;
                            }
                            square.add(num);
                        }
                    }
                }

                const messageDiv = document.getElementById('message');
                if (isCorrect) {
                    messageDiv.textContent = translations[currentLanguage].completed;
                    messageDiv.className = 'message success';
                } else {
                    messageDiv.textContent = translations[currentLanguage].incorrect;
                    messageDiv.className = 'message error';
                }
            }
        }

        function updateCell(row, col, value) {
            if (isLocked && !initialCells.has(`${row},${col}`)) {
                showMessage(translations[currentLanguage].inputLocked, 'error');
                return;
            }
            
            const num = parseInt(value) || 0;
            if (num >= 0 && num <= 9) {
                board[row][col] = num;
                updateGrid();
                // ÊØèÊ¨°Êõ¥Êñ∞ÂçïÂÖÉÊ†ºÂêéÊ£ÄÊü•ÊòØÂê¶ÂÆåÊàê
                checkCompletion();
            }
        }

        function toggleHelp() {
            const modal = document.getElementById('helpModal');
            if (modal.style.display === 'block') {
                modal.style.display = 'none';
            } else {
                modal.style.display = 'block';
            }
        }

        // ÁÇπÂáªÊ®°ÊÄÅÊ°ÜÂ§ñÈÉ®Êó∂ÂÖ≥Èó≠
        window.onclick = function(event) {
            const modal = document.getElementById('helpModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }

        // ÂàùÂßãÂåñËÆæÁΩÆÂíåÊ£ãÁõò
        initializeSettings();
        createGrid();
    </script>
</body>
</html> 