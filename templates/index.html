<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°ç‹¬æç¤ºå™¨ | Sudoku Tips Giver</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ²</text></svg>">
    <style>
        :root {
            --bg-color: #f0f0f0;
            --container-bg: white;
            --text-color: #333;
            --cell-bg: white;
            --cell-border: #ddd;
            --grid-border: #333;
            --highlight-bg: #e6f3ff;
            --button-bg: #007bff;
            --button-hover: #0056b3;
            --success-bg: #e6ffe6;
            --success-color: #28a745;
            --error-bg: #ffe6e6;
            --error-color: #dc3545;
        }

        [data-theme="dark"] {
            --bg-color: #222;
            --container-bg: #333;
            --text-color: #fff;
            --cell-bg: #444;
            --cell-border: #555;
            --grid-border: #666;
            --highlight-bg: #1a3f66;
            --button-bg: #0056b3;
            --button-hover: #003d80;
            --success-bg: #143322;
            --success-color: #28a745;
            --error-bg: #331111;
            --error-color: #dc3545;
        }

        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: all 0.3s ease;
        }

        .container {
            margin: 20px auto;  /* ä¿®æ”¹ä¸ºautoä»¥å®ç°æ°´å¹³å±…ä¸­ */
            padding: 20px;
            background-color: var(--container-bg);
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            max-width: 600px;  /* æ·»åŠ æœ€å¤§å®½åº¦é™åˆ¶ */
            width: 100%;  /* ç¡®ä¿å“åº”å¼å¸ƒå±€ */
        }

        .header-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            gap: 10px;
        }

        .control-buttons {
            display: flex;
            gap: 10px;
        }

        .theme-toggle, .lang-toggle {
            background: none;
            border: 1px solid var(--text-color);
            color: var(--text-color);
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        .theme-toggle:hover, .lang-toggle:hover {
            background-color: var(--text-color);
            color: var(--bg-color);
        }

        .sudoku-grid {
            display: grid;
            grid-template-columns: repeat(9, 50px);
            gap: 1px;
            background-color: var(--grid-border);
            border: 2px solid var(--grid-border);
            margin: 20px auto;
            padding: 2px;
            position: relative;
            box-sizing: border-box;
            width: fit-content;
        }

        .loading-overlay {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(3px);
            z-index: 100;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        [data-theme="dark"] .loading-overlay {
            background-color: rgba(0, 0, 0, 0.8);
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--button-bg);
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
        }

        .button-spinner {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid #fff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
            margin-left: 8px;
            vertical-align: middle;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .cell {
            width: 50px;
            height: 50px;
            background-color: var(--cell-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid var(--cell-border);
            box-sizing: border-box;
            padding: 0;
        }

        .cell input {
            width: 100%;
            height: 100%;
            border: none;
            text-align: center;
            font-size: 20px;
            padding: 0;
            margin: 0;
            box-sizing: border-box;
            background: transparent;
            color: var(--text-color);
        }

        .cell input:disabled {
            color: var(--text-color);
            opacity: 0.7;
            cursor: not-allowed;
            background: transparent;
            caret-color: transparent;  /* éšè—å…‰æ ‡ */
        }

        .cell input.initial {
            font-weight: bold;
            color: var(--text-color);
        }

        .cell input:not(:disabled):focus {
            outline: 2px solid var(--button-bg);
        }

        .cell.highlighted {
            background-color: var(--highlight-bg);
        }

        .grid-line-right {
            border-right: 2px solid var(--grid-border) !important;
        }

        .grid-line-bottom {
            border-bottom: 2px solid var(--grid-border) !important;
        }

        .buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;  /* å…è®¸æŒ‰é’®æ¢è¡Œ */
            justify-content: center;  /* å±…ä¸­å¯¹é½æŒ‰é’® */
        }

        button {
            padding: 10px 15px;  /* ç¨å¾®å‡å°padding */
            font-size: 14px;  /* ç¨å¾®å‡å°å­—ä½“å¤§å° */
            cursor: pointer;
            background-color: var(--button-bg);
            color: white;
            border: none;
            border-radius: 5px;
            transition: background-color 0.3s ease;
            white-space: nowrap;  /* é˜²æ­¢æŒ‰é’®æ–‡å­—æ¢è¡Œ */
        }

        button:hover {
            background-color: var(--button-hover);
        }

        button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .message {
            margin-top: 20px;
            padding: 10px;
            border-radius: 5px;
            min-height: 50px;
        }

        .error {
            background-color: var(--error-bg);
            color: var(--error-color);
        }

        .success {
            background-color: var(--success-bg);
            color: var(--success-color);
        }

        .buttons select {
            padding: 10px 15px;
            font-size: 14px;
            border: 1px solid var(--button-bg);
            border-radius: 5px;
            background-color: var(--cell-bg);
            color: var(--text-color);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .buttons select:hover {
            border-color: var(--button-hover);
        }

        .buttons select option {
            background-color: var(--container-bg);
            color: var(--text-color);
        }

        .help-button {
            background: none;
            border: 1px solid var(--text-color);
            color: var(--text-color);
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-left: 10px;
        }

        .help-button:hover {
            background-color: var(--text-color);
            color: var(--bg-color);
        }

        .help-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .help-content {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--container-bg);
            color: var(--text-color);
            padding: 20px;
            border-radius: 10px;
            width: 80%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .close-help {
            position: absolute;
            right: 20px;
            top: 20px;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-color);
        }

        .help-content h2 {
            margin-top: 0;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--text-color);
        }

        .help-content h3 {
            margin-top: 20px;
            color: var(--button-bg);
        }

        .help-content ul {
            padding-left: 20px;
        }

        .help-content li {
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-controls">
            <h1 class="lang-zh">æ•°ç‹¬æç¤ºå™¨</h1>
            <h1 class="lang-en" style="display: none;">Sudoku Tips Giver</h1>
            <div class="control-buttons">
                <button class="theme-toggle" onclick="toggleTheme()">ğŸŒ“</button>
                <button class="lang-toggle" onclick="toggleLanguage()">ä¸­/En</button>
                <button class="help-button" onclick="toggleHelp()">?</button>
            </div>
        </div>
        <div class="buttons">
            <select id="difficulty" class="lang-zh">
                <option value="easy">ç®€å•</option>
                <option value="medium" selected>ä¸­ç­‰</option>
                <option value="hard">å›°éš¾</option>
            </select>
            <select id="difficulty-en" class="lang-en" style="display: none;">
                <option value="easy">Easy</option>
                <option value="medium" selected>Medium</option>
                <option value="hard">Hard</option>
            </select>
            <button onclick="generateSudoku()" class="lang-zh">ç”Ÿæˆæ•°ç‹¬</button>
            <button onclick="getHint()" class="lang-zh">è·å–æç¤º</button>
            <button onclick="showAnswer()" class="lang-zh">æ˜¾ç¤ºç­”æ¡ˆ</button>
            <button onclick="clearBoard()" class="lang-zh">æ¸…ç©ºæ£‹ç›˜</button>
            <button onclick="generateSudoku()" class="lang-en" style="display: none;">Generate Sudoku</button>
            <button onclick="getHint()" class="lang-en" style="display: none;">Get Hint</button>
            <button onclick="showAnswer()" class="lang-en" style="display: none;">Show Answer</button>
            <button onclick="clearBoard()" class="lang-en" style="display: none;">Clear Board</button>
        </div>
        <div class="sudoku-grid" id="grid">
            <div class="loading-overlay" id="gridLoading" style="display: none;">
                <div class="loading-spinner"></div>
            </div>
        </div>
        <div class="message" id="message"></div>
    </div>

    <!-- å¸®åŠ©æ¨¡æ€æ¡† -->
    <div class="help-modal" id="helpModal">
        <div class="help-content">
            <span class="close-help" onclick="toggleHelp()">&times;</span>
            <div class="lang-zh">
                <h2>ä½¿ç”¨å¸®åŠ©</h2>
                
                <h3>éš¾åº¦çº§åˆ«</h3>
                <ul>
                    <li><strong>ç®€å•</strong>ï¼šåˆå§‹æ•°å­— 35-40 ä¸ªï¼Œé€‚åˆåˆå­¦è€…</li>
                    <li><strong>ä¸­ç­‰</strong>ï¼šåˆå§‹æ•°å­— 25-30 ä¸ªï¼Œéœ€è¦ä¸€å®šè§£é¢˜æŠ€å·§</li>
                    <li><strong>å›°éš¾</strong>ï¼šåˆå§‹æ•°å­— 20-25 ä¸ªï¼Œå¯Œæœ‰æŒ‘æˆ˜æ€§</li>
                </ul>

                <h3>æŒ‰é’®åŠŸèƒ½</h3>
                <ul>
                    <li><strong>ç”Ÿæˆæ•°ç‹¬</strong>ï¼šæ ¹æ®é€‰æ‹©çš„éš¾åº¦ç”Ÿæˆæ–°çš„æ•°ç‹¬é¢˜ç›®</li>
                    <li><strong>è·å–æç¤º</strong>ï¼šé«˜äº®æ˜¾ç¤ºæœ€é€‚åˆå¡«å†™çš„æ ¼å­ï¼Œå¹¶æä¾›å¯èƒ½çš„æ•°å­—</li>
                    <li><strong>æ˜¾ç¤ºç­”æ¡ˆ</strong>ï¼šåœ¨é«˜äº®æ ¼å­ä¸­å¡«å…¥æ­£ç¡®ç­”æ¡ˆ</li>
                    <li><strong>æ¸…ç©ºæ£‹ç›˜</strong>ï¼šæ¸…é™¤æ‰€æœ‰å·²å¡«å†™çš„æ•°å­—ï¼Œé‡æ–°å¼€å§‹</li>
                </ul>

                <h3>æ“ä½œè¯´æ˜</h3>
                <ul>
                    <li>ä½¿ç”¨é¼ æ ‡ç‚¹å‡»æ ¼å­æˆ–é”®ç›˜æ–¹å‘é”®è¿›è¡Œå¯¼èˆª</li>
                    <li>ç›´æ¥è¾“å…¥æ•°å­— 1-9</li>
                    <li>æŒ‰é€€æ ¼é”®æ¸…é™¤å½“å‰æ ¼å­</li>
                    <li>ç³»ç»Ÿä¼šè‡ªåŠ¨æ£€æŸ¥æ˜¯å¦å®Œæˆ</li>
                </ul>

                <h3>ç•Œé¢æ§åˆ¶</h3>
                <ul>
                    <li>ğŸŒ“ï¼šåˆ‡æ¢æ·±è‰²/æµ…è‰²ä¸»é¢˜</li>
                    <li>ä¸­/Enï¼šåˆ‡æ¢ä¸­æ–‡/è‹±æ–‡ç•Œé¢</li>
                    <li>?ï¼šæ˜¾ç¤º/éšè—å¸®åŠ©ä¿¡æ¯</li>
                </ul>
            </div>
            <div class="lang-en" style="display: none;">
                <h2>Help Guide</h2>
                
                <h3>Difficulty Levels</h3>
                <ul>
                    <li><strong>Easy</strong>: 35-40 initial numbers, suitable for beginners</li>
                    <li><strong>Medium</strong>: 25-30 initial numbers, requires some solving techniques</li>
                    <li><strong>Hard</strong>: 20-25 initial numbers, challenging</li>
                </ul>

                <h3>Button Functions</h3>
                <ul>
                    <li><strong>Generate Sudoku</strong>: Creates a new puzzle based on selected difficulty</li>
                    <li><strong>Get Hint</strong>: Highlights the most suitable cell to fill and shows possible numbers</li>
                    <li><strong>Show Answer</strong>: Fills in the correct number in the highlighted cell</li>
                    <li><strong>Clear Board</strong>: Removes all filled numbers and starts over</li>
                </ul>

                <h3>How to Play</h3>
                <ul>
                    <li>Use mouse clicks or arrow keys for navigation</li>
                    <li>Input numbers 1-9 directly</li>
                    <li>Press Backspace to clear current cell</li>
                    <li>System automatically checks for completion</li>
                </ul>

                <h3>Interface Controls</h3>
                <ul>
                    <li>ğŸŒ“: Toggle dark/light theme</li>
                    <li>ä¸­/En: Switch between Chinese/English</li>
                    <li>?: Show/hide help information</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        let board = Array(9).fill().map(() => Array(9).fill(0));
        let highlightedCell = null;
        let currentLanguage = 'zh';
        let solvedBoard = null;  // å­˜å‚¨å®Œæ•´è§£
        let isLocked = false;    // æ˜¯å¦é”å®šè¾“å…¥
        let initialCells = new Set();  // å­˜å‚¨åˆå§‹æ•°å­—çš„ä½ç½®
        
        // è¯­è¨€é…ç½®
        const translations = {
            zh: {
                noUniqueSolution: 'è¿™ä¸ªæ•°ç‹¬æ²¡æœ‰å”¯ä¸€è§£ï¼',
                completed: 'æ­å–œï¼æ•°ç‹¬å·²æ­£ç¡®å®Œæˆï¼',
                incorrect: 'æ•°ç‹¬å¡«å†™æœ‰è¯¯ï¼Œè¯·æ£€æŸ¥åé‡è¯•ï¼',
                error: 'å‘ç”Ÿé”™è¯¯ï¼Œè¯·é‡è¯•',
                inputLocked: 'å·²é”å®šè¾“å…¥ã€‚å¦‚éœ€ä¿®æ”¹ï¼Œè¯·ç‚¹å‡»æ¸…ç©ºæ£‹ç›˜é‡æ–°å¼€å§‹ã€‚',
                generateError: 'ç”Ÿæˆæ•°ç‹¬æ—¶å‘ç”Ÿé”™è¯¯'
            },
            en: {
                noUniqueSolution: 'This Sudoku has no unique solution!',
                completed: 'Congratulations! Sudoku completed correctly!',
                incorrect: 'The Sudoku is incorrect. Please check and try again!',
                error: 'An error occurred, please try again',
                inputLocked: 'Input is locked. To modify, please click Clear Board to start over.',
                generateError: 'Error generating Sudoku'
            }
        };

        function toggleTheme() {
            document.body.dataset.theme = document.body.dataset.theme === 'dark' ? 'light' : 'dark';
            localStorage.setItem('theme', document.body.dataset.theme);
        }

        function toggleLanguage() {
            currentLanguage = currentLanguage === 'zh' ? 'en' : 'zh';
            document.querySelectorAll('.lang-zh').forEach(el => 
                el.style.display = currentLanguage === 'zh' ? '' : 'none'
            );
            document.querySelectorAll('.lang-en').forEach(el => 
                el.style.display = currentLanguage === 'en' ? '' : 'none'
            );
            localStorage.setItem('language', currentLanguage);
            
            // æ›´æ–°æ¶ˆæ¯å†…å®¹
            const messageDiv = document.getElementById('message');
            if (messageDiv.textContent) {
                translateMessage(messageDiv);
            }
        }

        function translateMessage(messageDiv) {
            // ç¿»è¯‘æç¤ºæ¶ˆæ¯
            Object.entries(translations[currentLanguage === 'zh' ? 'en' : 'zh']).forEach(([key, value]) => {
                if (messageDiv.textContent.includes(value)) {
                    messageDiv.textContent = messageDiv.textContent.replace(
                        value,
                        translations[currentLanguage][key]
                    );
                    return;
                }
            });
            
            // ç¿»è¯‘æ•°ç‹¬æç¤ºæ¶ˆæ¯
            if (currentLanguage === 'en') {
                messageDiv.textContent = messageDiv.textContent
                    .replace(/ç¬¬(\d+)è¡Œç¬¬(\d+)åˆ—/g, 'Row $1, Column $2')
                    .replace(/åªèƒ½å¡«å…¥æ•°å­—(\d+)/, 'can only be filled with number $1')
                    .replace(/å¯ä»¥å¡«å…¥çš„æ•°å­—æœ‰:/, 'Possible numbers are:');
            } else {
                messageDiv.textContent = messageDiv.textContent
                    .replace(/Row (\d+), Column (\d+)/g, 'ç¬¬$1è¡Œç¬¬$2åˆ—')
                    .replace(/can only be filled with number (\d+)/, 'åªèƒ½å¡«å…¥æ•°å­—$1')
                    .replace(/Possible numbers are:/, 'å¯ä»¥å¡«å…¥çš„æ•°å­—æœ‰:');
            }
        }

        // åˆå§‹åŒ–ä¸»é¢˜å’Œè¯­è¨€
        function initializeSettings() {
            // è®¾ç½®ä¸»é¢˜
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.body.dataset.theme = savedTheme;
            
            // è®¾ç½®è¯­è¨€
            const savedLanguage = localStorage.getItem('language') || 'zh';
            if (savedLanguage !== currentLanguage) {
                currentLanguage = savedLanguage;
                toggleLanguage();
            }
        }

        function updateGrid() {
            const inputs = document.querySelectorAll('#grid input');  // ä¿®æ”¹é€‰æ‹©å™¨
            board.forEach((row, i) => {
                row.forEach((value, j) => {
                    const input = inputs[i * 9 + j];
                    if (input) {  // æ·»åŠ æ£€æŸ¥
                        input.value = value || '';
                        input.disabled = isLocked || initialCells.has(`${i},${j}`);
                        input.className = initialCells.has(`${i},${j}`) ? 'initial' : '';
                    }
                });
            });
        }

        async function generateSudoku() {
            try {
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                const gridLoading = document.getElementById('gridLoading');
                const generateButton = document.querySelector(`.lang-${currentLanguage}[onclick="generateSudoku()"]`);
                
                // åªç¦ç”¨æ¸¸æˆç›¸å…³çš„æŒ‰é’®å’Œé€‰æ‹©æ¡†
                const gameButtons = document.querySelectorAll('.buttons button');
                const difficultySelects = document.querySelectorAll('#difficulty, #difficulty-en');
                
                if (gridLoading) {
                    gridLoading.style.display = 'flex';
                }
                
                if (generateButton) {
                    generateButton.innerHTML = currentLanguage === 'zh' ? 
                        'æ­£åœ¨ç”Ÿæˆ<span class="button-spinner"></span>' : 
                        'Generating<span class="button-spinner"></span>';
                }

                // åªç¦ç”¨æ¸¸æˆç›¸å…³çš„æŒ‰é’®å’Œé€‰æ‹©æ¡†
                gameButtons.forEach(btn => btn.disabled = true);
                difficultySelects.forEach(select => select.disabled = true);

                const difficulty = document.getElementById(currentLanguage === 'zh' ? 'difficulty' : 'difficulty-en')?.value || 'medium';
                const response = await fetch('/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ difficulty: difficulty })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                if (data.success) {
                    board = data.board;
                    solvedBoard = data.solution;
                    initialCells.clear();
                    isLocked = false;
                    
                    board.forEach((row, i) => {
                        row.forEach((value, j) => {
                            if (value) {
                                initialCells.add(`${i},${j}`);
                            }
                        });
                    });
                    
                    updateGrid();
                    clearHighlight();
                    const messageDiv = document.getElementById('message');
                    if (messageDiv) {
                        messageDiv.textContent = '';
                        messageDiv.className = 'message';
                    }
                } else {
                    console.error('Generation failed:', data.message);
                    const messageDiv = document.getElementById('message');
                    if (messageDiv) {
                        messageDiv.className = 'message error';
                        messageDiv.textContent = data.message || translations[currentLanguage].generateError;
                    }
                }
            } catch (error) {
                console.error('Error:', error);
                const messageDiv = document.getElementById('message');
                if (messageDiv) {
                    messageDiv.className = 'message error';
                    messageDiv.textContent = translations[currentLanguage].generateError + (error.message ? `: ${error.message}` : '');
                }
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                const gridLoading = document.getElementById('gridLoading');
                const generateButton = document.querySelector(`.lang-${currentLanguage}[onclick="generateSudoku()"]`);
                const gameButtons = document.querySelectorAll('.buttons button');
                const difficultySelects = document.querySelectorAll('#difficulty, #difficulty-en');
                
                // ç§»é™¤åŠ è½½çŠ¶æ€
                if (gridLoading) {
                    gridLoading.style.display = 'none';
                }
                
                if (generateButton) {
                    generateButton.innerHTML = currentLanguage === 'zh' ? 'ç”Ÿæˆæ•°ç‹¬' : 'Generate Sudoku';
                }
                
                // åªå¯ç”¨æ¸¸æˆç›¸å…³çš„æŒ‰é’®å’Œé€‰æ‹©æ¡†
                gameButtons.forEach(btn => btn.disabled = false);
                difficultySelects.forEach(select => select.disabled = false);
            }
        }

        function createGrid() {
            const grid = document.getElementById('grid');
            grid.innerHTML = '';  // æ¸…ç©ºç°æœ‰å†…å®¹
            for (let i = 0; i < 9; i++) {
                for (let j = 0; j < 9; j++) {
                    const cell = document.createElement('div');  // åˆ›å»ºdivä½œä¸ºå®¹å™¨
                    cell.className = 'cell';
                    if (j === 2 || j === 5) cell.className += ' grid-line-right';
                    if (i === 2 || i === 5) cell.className += ' grid-line-bottom';

                    const input = document.createElement('input');
                    input.type = 'text';
                    input.maxLength = 1;
                    input.dataset.row = i;
                    input.dataset.col = j;
                    
                    input.addEventListener('input', (e) => {
                        if (isLocked || initialCells.has(`${i},${j}`)) {
                            e.preventDefault();
                            e.target.value = board[i][j] || '';
                            const messageDiv = document.getElementById('message');
                            messageDiv.className = 'message error';
                            messageDiv.textContent = translations[currentLanguage].inputLocked;
                            return;
                        }
                        
                        const value = e.target.value;
                        if (value === '0') {  // å¦‚æœè¾“å…¥0
                            e.target.value = '';  // æ¸…ç©ºæ ¼å­
                            board[i][j] = 0;
                            moveToNextCell(i, j);  // ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªæ ¼å­
                            checkCompletion();
                        } else if (value && (isNaN(value) || value < 0 || value > 9)) {
                            e.target.value = '';
                        } else {
                            board[i][j] = value ? parseInt(value) : 0;
                            if (value) {  // åªæœ‰è¾“å…¥1-9æ—¶æ‰ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªæ ¼å­
                                moveToNextCell(i, j);
                            }
                            checkCompletion();
                        }
                    });

                    // æ·»åŠ é”®ç›˜å¯¼èˆª
                    input.addEventListener('keydown', (e) => {
                        const row = parseInt(e.target.dataset.row);
                        const col = parseInt(e.target.dataset.col);
                        
                        switch(e.key) {
                            case 'ArrowUp':
                                moveFocus(row - 1, col);
                                e.preventDefault();
                                break;
                            case 'ArrowDown':
                                moveFocus(row + 1, col);
                                e.preventDefault();
                                break;
                            case 'ArrowLeft':
                                moveFocus(row, col - 1);
                                e.preventDefault();
                                break;
                            case 'ArrowRight':
                                moveFocus(row, col + 1);
                                e.preventDefault();
                                break;
                            case ' ':  // ç©ºæ ¼é”®
                                moveToNextCell(row, col);
                                e.preventDefault();
                                break;
                            case 'Backspace':
                                if (!e.target.value) { // å¦‚æœå½“å‰æ ¼å­ä¸ºç©ºï¼Œç§»åŠ¨åˆ°ä¸Šä¸€ä¸ªæ ¼å­
                                    moveToPrevCell(row, col);
                                    e.preventDefault();
                                }
                                break;
                        }
                    });
                    
                    cell.appendChild(input);  // å°†inputæ·»åŠ åˆ°cellä¸­
                    grid.appendChild(cell);
                }
            }
            updateGrid();  // æ›´æ–°ç½‘æ ¼æ˜¾ç¤º
        }

        function moveToNextCell(currentRow, currentCol) {
            let nextRow = currentRow;
            let nextCol = currentCol + 1;
            
            if (nextCol >= 9) {
                nextCol = 0;
                nextRow++;
            }
            if (nextRow < 9) {
                moveFocus(nextRow, nextCol);
            }
        }

        function moveToPrevCell(currentRow, currentCol) {
            let prevRow = currentRow;
            let prevCol = currentCol - 1;
            
            while (prevRow >= 0) {
                while (prevCol >= 0) {
                    const input = document.querySelector(`[data-row="${prevRow}"][data-col="${prevCol}"]`);
                    if (input && !input.disabled) {
                        input.focus();
                        return;
                    }
                    prevCol--;
                }
                prevRow--;
                prevCol = 8;
            }
        }

        function moveFocus(row, col) {
            if (row >= 0 && row < 9 && col >= 0 && col < 9) {
                const nextInput = document.querySelector(`[data-row="${row}"][data-col="${col}"]`);
                if (nextInput && !nextInput.disabled) {
                    nextInput.focus();
                } else {
                    // å¦‚æœä¸‹ä¸€ä¸ªæ ¼å­è¢«ç¦ç”¨ï¼Œç»§ç»­å¯»æ‰¾ä¸‹ä¸€ä¸ªå¯ç”¨çš„æ ¼å­
                    let nextRow = row;
                    let nextCol = col;
                    while (nextRow < 9) {
                        while (nextCol < 9) {
                            const input = document.querySelector(`[data-row="${nextRow}"][data-col="${nextCol}"]`);
                            if (input && !input.disabled) {
                                input.focus();
                                return;
                            }
                            nextCol++;
                        }
                        nextRow++;
                        nextCol = 0;
                    }
                }
            }
        }

        function clearHighlight() {
            if (highlightedCell) {
                highlightedCell.classList.remove('highlighted');
                highlightedCell = null;
            }
        }

        function highlightCell(row, col) {
            clearHighlight();
            const input = document.querySelector(`#grid input[data-row="${row}"][data-col="${col}"]`);
            if (input) {
                input.parentElement.classList.add('highlighted');
                highlightedCell = input.parentElement;
            }
        }

        async function getHint() {
            try {
                // é¦–å…ˆæ£€æŸ¥æ˜¯å¦æ‰€æœ‰æ ¼å­éƒ½å·²å¡«å†™
                let isFull = true;
                for (let i = 0; i < 9; i++) {
                    for (let j = 0; j < 9; j++) {
                        if (board[i][j] === 0) {
                            isFull = false;
                            break;
                        }
                    }
                    if (!isFull) break;
                }

                if (isFull) {
                    // å¦‚æœå·²å¡«æ»¡ï¼Œæ£€æŸ¥æ˜¯å¦æ­£ç¡®
                    const messageDiv = document.getElementById('message');
                    clearHighlight(); // æ¸…é™¤é«˜äº®
                    
                    // æ£€æŸ¥æ¯ä¸€è¡Œ
                    for (let i = 0; i < 9; i++) {
                        let row = new Set();
                        for (let j = 0; j < 9; j++) {
                            if (row.has(board[i][j])) {
                                messageDiv.className = 'message error';
                                messageDiv.textContent = translations[currentLanguage].incorrect;
                                return;
                            }
                            row.add(board[i][j]);
                        }
                    }
                    
                    // æ£€æŸ¥æ¯ä¸€åˆ—
                    for (let j = 0; j < 9; j++) {
                        let col = new Set();
                        for (let i = 0; i < 9; i++) {
                            if (col.has(board[i][j])) {
                                messageDiv.className = 'message error';
                                messageDiv.textContent = translations[currentLanguage].incorrect;
                                return;
                            }
                            col.add(board[i][j]);
                        }
                    }
                    
                    // æ£€æŸ¥æ¯ä¸ª3x3æ–¹æ ¼
                    for (let block = 0; block < 9; block++) {
                        let square = new Set();
                        let startRow = Math.floor(block / 3) * 3;
                        let startCol = (block % 3) * 3;
                        for (let i = 0; i < 3; i++) {
                            for (let j = 0; j < 3; j++) {
                                let num = board[startRow + i][startCol + j];
                                if (square.has(num)) {
                                    messageDiv.className = 'message error';
                                    messageDiv.textContent = translations[currentLanguage].incorrect;
                                    return;
                                }
                                square.add(num);
                            }
                        }
                    }
                    
                    // å¦‚æœæ‰€æœ‰æ£€æŸ¥éƒ½é€šè¿‡ï¼Œæ˜¾ç¤ºå®Œæˆæ¶ˆæ¯
                    messageDiv.className = 'message success';
                    messageDiv.textContent = translations[currentLanguage].completed;
                    return;
                }

                const response = await fetch('/get_hint', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ board: board })
                });
                
                const data = await response.json();
                const messageDiv = document.getElementById('message');
                
                if (data.success) {
                    messageDiv.className = 'message success';
                    messageDiv.textContent = data.message;
                    messageDiv.dataset.number = data.number;
                    messageDiv.dataset.possibleNumbers = JSON.stringify(data.possible_numbers);
                    solvedBoard = data.solved_board;  // ä¿å­˜å®Œæ•´è§£
                    highlightCell(data.row, data.col);
                } else {
                    messageDiv.className = 'message error';
                    messageDiv.textContent = currentLanguage === 'zh' ? 
                        translations.zh.noUniqueSolution : 
                        translations.en.noUniqueSolution;
                    messageDiv.dataset.number = '';
                    messageDiv.dataset.possibleNumbers = '';
                    solvedBoard = null;
                    clearHighlight();
                }
                
                if (currentLanguage === 'en') {
                    translateMessage(messageDiv);
                }
            } catch (error) {
                console.error('Error:', error);
                const messageDiv = document.getElementById('message');
                messageDiv.className = 'message error';
                messageDiv.textContent = currentLanguage === 'zh' ? 
                    translations.zh.error : 
                    translations.en.error;
            }
        }

        async function showAnswer() {
            // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰æ ¼å­éƒ½å·²å¡«å†™
            let isFull = true;
            for (let i = 0; i < 9; i++) {
                for (let j = 0; j < 9; j++) {
                    if (board[i][j] === 0) {
                        isFull = false;
                        break;
                    }
                }
                if (!isFull) break;
            }

            if (isFull) {
                await getHint();  // å¦‚æœå·²å¡«æ»¡ï¼Œè°ƒç”¨getHintæ£€æŸ¥æ˜¯å¦æ­£ç¡®
                return;
            }

            const messageDiv = document.getElementById('message');
            
            if (!highlightedCell || !messageDiv.className.includes('success')) {
                await getHint();
                if (!messageDiv.className.includes('success')) {
                    return;
                }
            }
            
            if (solvedBoard && highlightedCell) {
                const input = highlightedCell.querySelector('input');
                if (input) {
                    const row = parseInt(input.dataset.row);
                    const col = parseInt(input.dataset.col);
                    const number = solvedBoard[row][col];
                    if (number) {
                        input.value = number;
                        board[row][col] = number;
                        initialCells.add(`${row},${col}`);  // å°†å¡«å†™çš„æ ¼å­æ ‡è®°ä¸ºåˆå§‹æ ¼å­
                        updateGrid();  // æ›´æ–°ç½‘æ ¼ä»¥åº”ç”¨ç¦ç”¨çŠ¶æ€
                        
                        // ä½¿ç”¨getHintæ¥å¯»æ‰¾ä¸‹ä¸€ä¸ªéœ€è¦æç¤ºçš„æ ¼å­
                        await getHint();
                    }
                }
            }
        }

        function clearBoard() {
            board = Array(9).fill().map(() => Array(9).fill(0));
            solvedBoard = null;
            isLocked = false;
            initialCells.clear();
            clearHighlight();
            updateGrid();
            // æ¸…é™¤æç¤ºä¿¡æ¯
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = '';
            messageDiv.className = 'message';
            messageDiv.dataset.number = '';
            messageDiv.dataset.possibleNumbers = '';
        }

        function checkCompletion() {
            // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰æ ¼å­éƒ½å·²å¡«å†™
            let isFull = true;
            for (let i = 0; i < 9; i++) {
                for (let j = 0; j < 9; j++) {
                    if (board[i][j] === 0) {
                        isFull = false;
                        break;
                    }
                }
            }

            if (isFull) {
                // æ£€æŸ¥æ˜¯å¦æ­£ç¡®
                let isCorrect = true;
                // æ£€æŸ¥æ¯ä¸€è¡Œ
                for (let i = 0; i < 9; i++) {
                    let row = new Set();
                    for (let j = 0; j < 9; j++) {
                        if (row.has(board[i][j])) {
                            isCorrect = false;
                            break;
                        }
                        row.add(board[i][j]);
                    }
                }
                // æ£€æŸ¥æ¯ä¸€åˆ—
                for (let j = 0; j < 9; j++) {
                    let col = new Set();
                    for (let i = 0; i < 9; i++) {
                        if (col.has(board[i][j])) {
                            isCorrect = false;
                            break;
                        }
                        col.add(board[i][j]);
                    }
                }
                // æ£€æŸ¥æ¯ä¸ª3x3æ–¹æ ¼
                for (let block = 0; block < 9; block++) {
                    let square = new Set();
                    let startRow = Math.floor(block / 3) * 3;
                    let startCol = (block % 3) * 3;
                    for (let i = 0; i < 3; i++) {
                        for (let j = 0; j < 3; j++) {
                            let num = board[startRow + i][startCol + j];
                            if (square.has(num)) {
                                isCorrect = false;
                                break;
                            }
                            square.add(num);
                        }
                    }
                }

                const messageDiv = document.getElementById('message');
                if (isCorrect) {
                    messageDiv.textContent = translations[currentLanguage].completed;
                    messageDiv.className = 'message success';
                } else {
                    messageDiv.textContent = translations[currentLanguage].incorrect;
                    messageDiv.className = 'message error';
                }
            }
        }

        function updateCell(row, col, value) {
            if (isLocked && !initialCells.has(`${row},${col}`)) {
                showMessage(translations[currentLanguage].inputLocked, 'error');
                return;
            }
            
            const num = parseInt(value) || 0;
            if (num >= 0 && num <= 9) {
                board[row][col] = num;
                updateGrid();
                // æ¯æ¬¡æ›´æ–°å•å…ƒæ ¼åæ£€æŸ¥æ˜¯å¦å®Œæˆ
                checkCompletion();
            }
        }

        function toggleHelp() {
            const modal = document.getElementById('helpModal');
            if (modal.style.display === 'block') {
                modal.style.display = 'none';
            } else {
                modal.style.display = 'block';
            }
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨æ—¶å…³é—­
        window.onclick = function(event) {
            const modal = document.getElementById('helpModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }

        // åˆå§‹åŒ–è®¾ç½®å’Œæ£‹ç›˜
        initializeSettings();
        createGrid();
    </script>
</body>
</html> 